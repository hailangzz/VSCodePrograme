
# nni_yolov_5_quant_demo.py

    # æ€»ä½“æ¦‚è¿°

    è¿™ä»½è„šæœ¬æ˜¯ä¸€ä¸ª**æ¼”ç¤ºç”¨çš„æœ€å°åŒ–æ¨¡æ¿**ï¼Œç›®çš„æ˜¯æ¼”ç¤ºå¦‚ä½•ç”¨ **NNI** å¯¹ **YOLOv5sï¼ˆultralyticsï¼‰** åšä¸¤ç§é‡åŒ–æµç¨‹ï¼š

    * **PTQï¼ˆPost-Training Quantizationï¼Œè®­ç»ƒåé‡åŒ–ï¼‰**ï¼šå¯¹å·²è®­ç»ƒå¥½çš„ fp32 æ¨¡å‹åšé‡åŒ–ï¼ˆé€šå¸¸éœ€è¦æ ¡å‡†é›†ï¼‰ï¼›
    * **QATï¼ˆQuantization-Aware Trainingï¼Œé‡åŒ–æ„ŸçŸ¥è®­ç»ƒï¼‰**ï¼šå…ˆæŠŠæ¨¡å‹åŒ…è£…ä¸ºå¸¦â€œå‡é‡åŒ–â€ï¼ˆfake-quantï¼‰æ¨¡å—çš„ç»“æ„ï¼Œç„¶åç»§ç»­è®­ç»ƒä»¥æ¢å¤ç²¾åº¦ï¼Œæœ€åå¯¼å‡ºçœŸæ­£çš„ int8 æƒé‡ã€‚

    è„šæœ¬é‡Œç”¨äº†ä¸€ä¸ªéå¸¸ç®€åŒ–çš„éšæœºæ•°æ®é›†ï¼ˆ`RandomDataset`ï¼‰å’Œéå¸¸å ä½å¼çš„æŸå¤±/è¯„ä¼°é€»è¾‘â€”â€”å› æ­¤**ä¸èƒ½ç›´æ¥ç”¨äºç”Ÿäº§/è¯„ä¼°ç²¾åº¦**ï¼Œä½†èƒ½å±•ç¤º NNI çš„åŸºæœ¬ç”¨æ³•å’Œæµç¨‹ã€‚

    ä¸‹é¢æˆ‘æŠŠä»£ç æŒ‰æ¨¡å—æ‹†å¼€ï¼Œé€å—è¯¦ç»†è§£é‡Šã€æŒ‡å‡ºæ˜“å‡ºé”™ç‚¹ä¸æ”¹è¿›å»ºè®®ã€‚

    ---

    # 1) æ–‡ä»¶å¤´ä¸ä¾èµ–è¯´æ˜

    è„šæœ¬å¼€å¤´çš„ docstring è¯´æ˜äº†ç”¨é€”ã€è¿è¡Œç¤ºä¾‹ä¸ä¾èµ–é¡¹ï¼š

    * éœ€è¦ `ultralytics`ï¼ˆç”¨äºåŠ è½½ yolov5sï¼‰ã€`nni`ã€`torch`/`torchvision` ç­‰ã€‚
    * ç¤ºä¾‹è¿è¡Œæ¨¡å¼ï¼š`--mode ptq` æˆ– `--mode qat`ã€‚

    ---

    # 2) importsï¼ˆå…³é”®åŒ…çš„ä½œç”¨ï¼‰

    * `from ultralytics import YOLO`ï¼šç”¨æ¥åŠ è½½ `yolov5s.pt`ï¼Œ`YOLO(...).model` å¯ä»¥å–å¾—åº•å±‚çš„ `torch.nn.Module`ã€‚
    * `import nni` ä¸ `from nni.compression.pytorch.quantization import QAT_Quantizer, PtqQuantizer`ï¼šNNI çš„é‡åŒ–å™¨ç±»ï¼ˆæ³¨æ„ï¼šNNI çš„ API åœ¨ä¸åŒç‰ˆæœ¬ä¸­æœ‰ç»†å¾®å·®åˆ«ï¼Œimport è·¯å¾„/å‡½æ•°ç­¾åå¯èƒ½ä¼šå˜ï¼‰ã€‚
    * å¸¸è§„çš„ `torch`, `torch.nn`, `DataLoader`, `Dataset`, `numpy`ï¼šæ„å»ºè®­ç»ƒ/æ ¡å‡†æ•°æ®å’Œè®­ç»ƒå¾ªç¯ã€‚

    ---

    # 3) æ•°æ®éƒ¨åˆ†ï¼š`RandomDataset` + `get_dataloader`

    * `RandomDataset` è¿”å› `(x, y)`ï¼š

    * `x` æ˜¯ `float32` éšæœºæ•°ç»„ï¼Œå½¢çŠ¶ `(3, H, W)`ï¼ˆè„šæœ¬ä¸­çš„ `img_size=640`ï¼‰ã€‚DataLoader çš„ `batch_size` ä¼šæŠŠå®ƒå˜æˆ `(B,3,H,W)`ã€‚
    * `y` æ˜¯ä¸€ä¸ªç®€å•çš„å ä½æ ‡ç­¾ `np.array([0,0,0,10,10])`ï¼Œè„šæœ¬å¹¶æ²¡æœ‰å®é™…ä½¿ç”¨æ ‡ç­¾æ¥è®¡ç®—çœŸå®çš„æ£€æµ‹æŸå¤±ã€‚
    * ç›®çš„ï¼š**å¿«é€Ÿè·‘é€šæµç¨‹**ï¼Œè€Œä¸æ˜¯è®­ç»ƒ/è¯„ä¼°çœŸå®æ£€æµ‹æ€§èƒ½ã€‚

    æ”¹è¿›å»ºè®®ï¼šæŠŠå®ƒæ›¿æ¢ä¸º COCO/YOLO æ ¼å¼çš„ dataloaderï¼ˆæˆ–ä½¿ç”¨ ultralytics è‡ªå¸¦çš„ dataloaderï¼‰ï¼Œå¹¶åšæ ‡å‡†çš„ letterbox/å½’ä¸€åŒ–/annotation parsingã€‚

    ---

    # 4) PTQ æµç¨‹ `ptq_demo(model, dataloader, config_list)`

    * è„šæ­¥è¦ç‚¹ï¼š`quantizer = PtqQuantizer(model, config_list)` ç„¶å `quantizer.compress()`ã€‚
    * è§£é‡Šï¼š

    * `PtqQuantizer` ä¼šæ ¹æ® `config_list` å†³å®šå“ªäº›å±‚éœ€è¦é‡åŒ–ï¼ˆæƒé‡/æ¿€æ´»/è¾“å…¥ï¼‰ï¼Œå¦‚ä½•é‡åŒ–ï¼ˆ8-bit / per-channel / symmetric/asymmetric ç­‰ï¼‰ã€‚
    * `compress()` åœ¨ PTQ åœºæ™¯ä¸‹é€šå¸¸éœ€è¦**æ ¡å‡†æ•°æ®**æ¥æ”¶é›†æ¿€æ´»èŒƒå›´ï¼ˆmin/maxï¼‰ä»¥ç”Ÿæˆ scale/zero-pointï¼Œè®¸å¤š NNI ç‰ˆæœ¬å…è®¸æŠŠæ ¡å‡† dataloader ä½œä¸ºå‚æ•°ä¼ å…¥ï¼ˆæˆ–é€šè¿‡ quantizer æä¾›çš„æ–¹æ³•è®¾ç½®ï¼‰ã€‚è„šæœ¬é‡Œæ²¡æœ‰æŠŠ `dataloader` æ˜¾å¼ä¼ å…¥ `compress()`ï¼Œè¿™åœ¨å®é™…ä½¿ç”¨æ—¶å¯èƒ½ä¸è¶³ä»¥å®Œæˆæ­£ç¡®çš„ PTQã€‚
    * å»ºè®®æ”¹è¿›ï¼š

    * æ˜¾å¼æŠŠæ ¡å‡†é›†ä¼ ç»™ `compress()`ï¼ˆä¾‹å¦‚ `compress(calib_dataloader=...)`ï¼Œå…·ä½“å‚æ•°åè¯·å‚ç…§ä½ å½“å‰ NNI ç‰ˆæœ¬çš„ APIï¼‰ã€‚
    * åœ¨ compress å®Œæˆåå¯¼å‡ºæ¨¡å‹ï¼ˆ`quantizer.export_model(...)`ï¼‰æˆ–ä¿å­˜é‡åŒ–æƒé‡ã€‚

    ---

    # 5) QAT æµç¨‹ `qat_demo(model, dataloader, config_list, epochs)`

    * æ­¥éª¤è¯´æ˜ï¼š

    1. `quantizer = QAT_Quantizer(model, config_list)`ï¼Œç„¶å `model = quantizer.compress()` â€”â€” è¿™ä¸€æ­¥æŠŠæ¨¡å‹åŒ…è£…æˆå«â€œfake-quantâ€æ“ä½œçš„å¯è®­ç»ƒæ¨¡å‹ï¼ˆå³åœ¨å‰å‘ä¸­æ¨¡æ‹Ÿé‡åŒ–è¯¯å·®ï¼‰ã€‚
    2. ä½¿ç”¨ `optim = torch.optim.SGD(...)` ä¸ `criterion = nn.MSELoss()`ï¼ˆè„šæœ¬é‡Œåªæ˜¯æ¼”ç¤ºç”¨çš„å ä½æŸå¤±ï¼‰è¿›è¡Œè®­ç»ƒå¾ªç¯ã€‚
    3. è®­ç»ƒå®Œæˆåè°ƒç”¨ `quantizer.export_model(model_path=..., calibration_path=...)` å°†é‡åŒ–åçš„æ¨¡å‹/æ ¡å‡†ä¿¡æ¯å¯¼å‡ºä¸ºå¯éƒ¨ç½²å½¢å¼ã€‚
    * å…³é”®ç‚¹/æ³¨æ„äº‹é¡¹ï¼š

    * åœ¨ QAT é˜¶æ®µéœ€è¦æŠŠæ¨¡å‹è®¾ä¸º `train()` å¹¶æŠŠæ•°æ®ã€æ¨¡å‹ç§»åŠ¨åˆ°åˆé€‚çš„è®¾å¤‡ï¼ˆCPU/CUDAï¼‰ã€‚è„šæœ¬ä¸­æ²¡æœ‰æ˜¾å¼ `to(device)`ï¼Œå› æ­¤åœ¨ GPU ç¯å¢ƒä¸‹ä¼šæŠ¥é”™æˆ–å®Œå…¨åœ¨ CPU ä¸Šè·‘ã€‚åŠ¡å¿…æŠŠ `model.to(device)`ï¼Œå¹¶åœ¨è®­ç»ƒæ—¶æŠŠæ¯ä¸ª `batch` ç§»åŠ¨åˆ° `device`ã€‚
    * è„šæœ¬ç”¨ MSE ä¸â€œå…¨ 0â€ä½œä¸ºæŸå¤±æ˜¯å ä½çš„ï¼Œ**çœŸå®åœºæ™¯éœ€è¦ä½¿ç”¨ YOLOv5 çš„æ£€æµ‹æŸå¤±ï¼ˆbbox loss + objectness + cls lossï¼‰**ï¼Œå¦åˆ™è®­ç»ƒæ²¡æœ‰å®é™…æ„ä¹‰ã€‚
    * `QAT_Quantizer.compress()` è¿”å›çš„ model å·²è¢«åŒ…è£…ï¼Œåç»­ `model.parameters()` åº”æ­£å¸¸ç”¨äºä¼˜åŒ–å™¨ï¼Œä½†éœ€æ³¨æ„æŸäº›é‡åŒ– wrapper å¯èƒ½ä¼šæŠŠåŸå§‹å‚æ•°æ”¾åœ¨ wrapper å†…ï¼Œæœ€å¥½æŒ‰ç…§ NNI æ–‡æ¡£æ¥è®¾ç½®ä¼˜åŒ–å™¨ï¼ˆä¾‹å¦‚åªä¼˜åŒ–å¯è®­ç»ƒå‚æ•°æˆ– wrapper æš´éœ²çš„å‚æ•°ï¼‰ã€‚
    * `export_model(...)` çš„è¡Œä¸ºï¼ˆæ˜¯å¦å¯¼å‡ºæœ€ç»ˆ int8 æƒé‡ã€æ˜¯å¦éœ€è¦é¢å¤–æ ¡å‡†æ­¥éª¤ï¼‰ä¾èµ– NNI ç‰ˆæœ¬ï¼›è¯·æŸ¥é˜…å¯¹åº”ç‰ˆæœ¬çš„ APIã€‚

    ---

    # 6) `config_list`ï¼ˆé‡åŒ–é…ç½®ï¼‰è¯¦è§£

    ç¤ºä¾‹é…ç½®ï¼š

    ```py
    config_list = [{
    'quant_types': ['weight', 'input'],
    'quant_bits': {'weight':8, 'input':8},
    'op_types': ['Conv2d', 'Linear']
    }]
    ```

    * `quant_types`ï¼šè¦é‡åŒ–çš„å¯¹è±¡ï¼ˆå¸¸è§ `'weight'`ã€`'activation'`ã€`'input'` ç­‰ï¼Œå…·ä½“åè¯ä¾ NNI ç‰ˆæœ¬ï¼‰ï¼›
    * `quant_bits`ï¼šæŒ‡å®šä½å®½ï¼Œä¾‹å¦‚æƒé‡ 8-bitï¼Œæ¿€æ´»/è¾“å…¥ 8-bitï¼›
    * `op_types`ï¼šé™å®šå“ªäº›æ“ä½œä¼šè¢«é‡åŒ–ï¼ˆåªé‡åŒ– Conv2dã€Linearï¼‰ã€‚

    > æ³¨æ„ï¼šä¸åŒ NNI ç‰ˆæœ¬ `config_list` çš„å­—æ®µåå’Œå…è®¸å€¼å¯èƒ½æœ‰å·®å¼‚ï¼ˆæ¯”å¦‚ `op_types` vs `op_names`ï¼Œ`quant_scheme`ã€`granularity` ç­‰ï¼‰ï¼Œä¸Šçº¿å‰è¯·å¯¹ç…§ä½ å®‰è£…çš„ NNI ç‰ˆæœ¬æ–‡æ¡£è°ƒæ•´ã€‚

    ---

    # 7) `main()` æµç¨‹æ€»ç»“

    * è§£æ CLI å‚æ•°ï¼ˆ`--mode ptq|qat`ã€`--epochs` ç­‰ï¼‰ã€‚
    * é€šè¿‡ `YOLO('yolov5s.pt').model` åŠ è½½ Ultralytics çš„åº•å±‚ `nn.Module`ã€‚
    * æ„å»º DataLoaderï¼ˆå½“å‰æ˜¯éšæœºå ä½é›†ï¼‰ã€‚
    * æ„é€  `config_list` å¹¶æ ¹æ® `--mode` è°ƒç”¨ `ptq_demo` æˆ– `qat_demo`ã€‚

    ---

    # 8) å¸¸è§é—®é¢˜ä¸æ”¹è¿›å»ºè®®ï¼ˆå¿…é¡»æ³¨æ„çš„ç‚¹ï¼‰

    1. **è®¾å¤‡ï¼ˆCPU/GPUï¼‰ç®¡ç†**

    * å¿…é¡» `model.to(device)`ï¼Œå¹¶åœ¨è®­ç»ƒ/æ ¡å‡†æ—¶æŠŠ `imgs`ã€`labels` ç§»åˆ°åŒä¸€ deviceã€‚
    * QAT åœ¨ GPU ä¸Šé€šå¸¸ä¼šæ˜¾è‘—åŠ é€Ÿè®­ç»ƒï¼›PTQ æ ¡å‡†ä¹Ÿèƒ½åˆ©ç”¨ GPU è®¡ç®—æ¿€æ´»ç»Ÿè®¡ã€‚

    2. **è¾“å…¥é¢„å¤„ç†**

    * å¯¹çœŸå®å›¾ç‰‡è¦åš letterboxã€å½’ä¸€åŒ–åˆ° `[0,1]`ï¼Œå¹¶æŠŠé€šé“é¡ºåºä¸æ¨¡å‹é»˜è®¤ä¸€è‡´ï¼ˆNCHWï¼‰ã€‚
    * éšæœºæ•°æ®è™½ç„¶èƒ½è·‘é€šï¼Œä½†ä¸æä¾›çœŸå®çš„æ ¡å‡†/è®­ç»ƒä¿¡å·ã€‚

    3. **çœŸå®æŸå¤±å‡½æ•°**

    * æ›¿æ¢ `nn.MSELoss` çš„å ä½å®ç°ä¸º YOLOv5 çš„å®˜æ–¹ lossï¼ˆclassification + box + objectnessï¼‰ã€‚ä½ å¯ä»¥ç›´æ¥å€Ÿç”¨ ultralytics çš„è®­ç»ƒä»£ç æˆ–æŠŠ `yolo.loss` éƒ¨åˆ†æå–è¿›æ¥ã€‚

    4. **PTQ è¦æœ‰æ ¡å‡†é›†**

    * PTQ çš„æ•ˆæœé«˜åº¦ä¾èµ–æ ¡å‡†æ•°æ®ï¼šåŠ¡å¿…æŠŠçœŸå®çš„å°æ‰¹é‡æ ¡å‡†å›¾åƒä¼ ç»™ PtqQuantizer çš„ compressï¼ˆæˆ–ç›¸åº”æ¥å£ï¼‰ã€‚

    5. **API/ç‰ˆæœ¬å…¼å®¹æ€§**

    * NNI åœ¨ä¸åŒç‰ˆæœ¬ä¸Š API ç»†èŠ‚ä¼šå˜åŒ–ï¼ˆä¾‹å¦‚ `quantization` æ¨¡å—è·¯å¾„ã€`compress` çš„è¿”å›å€¼/å‚æ•°ã€`export_model` çš„é€‰é¡¹ï¼‰ï¼Œä¸Šçº¿å‰è¯·å¯¹ç…§ä½ æœ¬åœ°çš„ NNI æ–‡æ¡£å¹¶åšå°ä¾‹å­éªŒè¯ã€‚

    6. **Ultralytics æ¨¡å‹å‰å‘å·®å¼‚**

    * Ultralytics çš„é¡¶å±‚ `YOLO` wrapper åœ¨è°ƒç”¨æ—¶ä¼šè¿”å›ä¸€ä¸ª `Results` å¯¹è±¡ï¼ˆåŒ…å« boxesã€masks ç­‰ï¼‰ï¼Œè€Œ `model`ï¼ˆåº•å±‚ `nn.Module`ï¼‰çš„åŸå§‹ forward å¯èƒ½è¿”å› raw tensorsã€‚é‡åŒ–/è®­ç»ƒæ—¶è¦ç»Ÿä¸€å¥½è°ƒç”¨æ–¹å¼ä¸ loss è®¡ç®—æ¥å£ã€‚

    7. **å¯¼å‡º/éƒ¨ç½²**

    * å®Œæˆé‡åŒ–å¹¶ `export_model` åï¼Œè‹¥è¦åœ¨æ¨ç†ç«¯é«˜æ•ˆéƒ¨ç½²ï¼Œå¸¸è§åšæ³•æœ‰ï¼šå¯¼å‡ºä¸º ONNXï¼ˆå¯èƒ½éœ€è¦å…ˆæŠŠé‡åŒ–æƒé‡è½¬ä¸º ONNX æ”¯æŒçš„æ ¼å¼ï¼‰ã€ç”¨ ONNX Runtime çš„ INT8 æ”¯æŒæˆ– TensorRT åšè¿›ä¸€æ­¥ä¼˜åŒ–ã€‚NNI å¯¼å‡ºçš„æ ¼å¼æ˜¯å¦ç›´æ¥å¯ç”¨å–å†³äº NNI çš„å¯¼å‡ºé€‰é¡¹ã€‚

    ---

    # 9) æ¨èä¸‹ä¸€æ­¥ï¼ˆæˆ‘å¯ä»¥å¸®ä½ çš„äº‹æƒ…ï¼‰

    å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ç«‹åˆ»ä¸ºä½ åšå…¶ä¸­ä»»æ„ä¸€é¡¹ï¼ˆæˆ‘ä¼šç›´æ¥ä¿®æ”¹å³ä¾§ä»£ç æ–‡ä»¶ï¼‰ï¼š

    * æŠŠ `RandomDataset` æ›¿æ¢ä¸ºä¸€ä¸ªåŸºäºä½ æ•°æ®é›†ï¼ˆCOCO / è‡ªå®šä¹‰ï¼‰çš„çœŸå® dataloaderï¼ˆå« letterboxã€label parsingï¼‰ã€‚
    * ä¸º PTQ å¢åŠ **æ˜¾å¼æ ¡å‡†æµç¨‹**ï¼ˆæŠŠæ ¡å‡† dataloader ä¼ å…¥ `PtqQuantizer.compress(...)` å¹¶ä¿å­˜å¯¼å‡ºçš„é‡åŒ–æ¨¡å‹ï¼‰ã€‚
    * æŠŠ QAT çš„è®­ç»ƒå¾ªç¯æ›¿æ¢ä¸º **YOLOv5 å®˜æ–¹è®­ç»ƒæŸå¤±**ï¼Œå¹¶è¡¥ä¸Š device è½¬ç§»ã€æ–­ç‚¹ä¿å­˜ã€å­¦ä¹ ç‡è°ƒåº¦ç­‰ã€‚
    * å¢åŠ  `export -> ONNX -> ONNX Runtime (int8)` çš„è¯´æ˜ä¸ç¤ºä¾‹è„šæœ¬ï¼Œç”¨äºéƒ¨ç½²/åŸºå‡†æµ‹è¯•ã€‚
    * å¸®ä½ ç¡®è®¤æœ¬åœ° NNI çš„ API å¹¶æŠŠä»£ç æ”¹æˆä¸ä½ çš„ NNI ç‰ˆæœ¬å…¼å®¹ï¼ˆéœ€è¦ä½ å‘Šè¯‰æˆ‘ `pip show nni` æˆ– `nni.__version__`ï¼Œæˆ–è€…å…è®¸æˆ‘æŒ‰å¸¸è§ç‰ˆæœ¬åšå…¼å®¹å¤„ç†ï¼‰ã€‚

    ä½ æƒ³å…ˆä»å“ªä¸€é¡¹å¼€å§‹ï¼Ÿéœ€è¦æˆ‘ç›´æ¥æŠŠ `nni_yolov5_quant_demo.py`ï¼ˆæˆ–å³ä¾§ `yolov5s_nni_quant_demo.py`ï¼‰æ”¹æˆæ›´â€œå¯ç”¨/å¯è·‘â€çš„ç‰ˆæœ¬å—ï¼Ÿ




# yolov_5_s_ptq_int_8_demo.py

    åŒºåˆ«ä¸»è¦åœ¨äºæˆ‘å¸®ä½ åŠ äº† **æ¨¡å‹å¯¼å‡ºå’Œæ¨ç†éªŒè¯** è¿™ä¸¤ä¸ªåŠŸèƒ½ï¼Œæ ¸å¿ƒè®­ç»ƒ/é‡åŒ–éƒ¨åˆ†æ²¡å˜ã€‚å¯ä»¥è¿™æ ·ç†è§£ï¼š

    ### ä¹‹å‰çš„è„šæœ¬

    * åªèƒ½åš **PTQ** å’Œ **QAT** ä¸¤ç§é‡åŒ–æµç¨‹ï¼›
    * é‡åŒ–ååªæ˜¯åœ¨ PyTorch é‡Œå¾—åˆ°ä¸€ä¸ªâ€œè¢«é‡åŒ–è¿‡çš„æ¨¡å‹â€ï¼›
    * æ²¡æœ‰å¯¼å‡ºï¼Œæ— æ³•ç›´æ¥éƒ¨ç½²åˆ° ONNX Runtime / TensorRT ç­‰æ¨ç†æ¡†æ¶ã€‚

    ### æ–°çš„è„šæœ¬ï¼ˆæˆ‘æ”¹è¿‡çš„ç‰ˆæœ¬ï¼‰

    åœ¨åŸæ¥åŸºç¡€ä¸Šæ–°å¢äº†ä¸¤éƒ¨åˆ†ï¼š

    1. **å¯¼å‡ºåˆ° ONNX (`export_to_onnx`)**

    * ç”¨ `torch.onnx.export` æŠŠé‡åŒ–åçš„ PyTorch æ¨¡å‹è½¬æˆ `.onnx` æ–‡ä»¶ï¼›
    * æ”¯æŒåŠ¨æ€ batch ç»´åº¦ï¼›
    * é€šè¿‡ `--export_onnx yolov5s_int8.onnx` å‚æ•°æ§åˆ¶å¯¼å‡ºè·¯å¾„ã€‚

    2. **ONNX Runtime æ¨ç† (`run_onnx_inference`)**

    * è‡ªåŠ¨åŠ è½½åˆšå¯¼å‡ºçš„ `.onnx` æ¨¡å‹ï¼›
    * æ„é€ ä¸€ä¸ªéšæœºè¾“å…¥å¼ é‡ï¼›
    * è·‘ä¸€æ¬¡å‰å‘æ¨ç†ï¼Œå¹¶è¾“å‡ºç»“æœçš„ shapeï¼ŒéªŒè¯æ¨¡å‹èƒ½åœ¨ ONNX Runtime ä¸‹è·‘é€šã€‚

    ### ä½¿ç”¨ä¸Šçš„å·®åˆ«

    * **ä¹‹å‰**ï¼š

    ```bash
    python yolov5s_nni_quant_demo.py --mode ptq
    python yolov5s_nni_quant_demo.py --mode qat --epochs 5
    ```

    * **ç°åœ¨**ï¼š
    é™¤äº†ä¸Šé¢çš„ï¼Œè¿˜å¯ä»¥ï¼š

    ```bash
    python yolov5s_nni_quant_demo.py --mode ptq --export_onnx yolov5s_int8.onnx
    ```

    è„šæœ¬ä¼šåœ¨é‡åŒ–åå¯¼å‡º ONNXï¼Œå¹¶ç”¨ ONNX Runtime è‡ªåŠ¨è·‘ä¸€æ¬¡æ¨ç†éªŒè¯ã€‚

    è¦ä¸è¦æˆ‘å†ç»™ä½ è¡¥ä¸Šä¸€ä¸ª **çœŸå®å›¾ç‰‡æ¨ç†çš„ç¤ºä¾‹**ï¼ˆè¯»å– jpg/pngï¼Œåš letterbox é¢„å¤„ç†ï¼Œç„¶åè·‘ ONNX Runtime è¾“å‡ºæ£€æµ‹ç»“æœï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥ç›´è§‚çœ‹åˆ°é‡åŒ–åæ¨¡å‹çš„æ•ˆæœï¼Ÿ


# nni_quant_export_onnx.py

    å®Œå…¨å¯ä»¥ ğŸ‘
    ä½ æåˆ°çš„ **ä¸¤ä¸ªä»£ç ** å®é™…ä¸Šå°±æ˜¯ï¼š

    1. **ç¬¬ä¸€ä¸ª Demo**ï¼šPyTorch é‡Œåš YOLOv5s çš„ PTQ + QATï¼ˆç”¨ NNIï¼‰ï¼Œä½†æ˜¯æ²¡æœ‰å¯¼å‡º ONNXï¼›
    2. **ç¬¬äºŒä¸ª Demo**ï¼šåœ¨ç¬¬ä¸€ä¸ªåŸºç¡€ä¸ŠåŠ äº† **export â†’ ONNX â†’ ONNX Runtime** çš„åŠŸèƒ½ã€‚

    æ‰€ä»¥åˆå¹¶èµ·æ¥çš„è„šæœ¬é€»è¾‘åº”è¯¥æ˜¯ï¼š

    * **åŠ è½½ YOLOv5s**ï¼›
    * **æ„å»º dataloader**ï¼ˆå¯ä»¥æ˜¯çœŸå®æ•°æ®ï¼Œä¹Ÿå¯ä»¥æ˜¯ RandomDatasetï¼‰ï¼›
    * **æ ¹æ®å‚æ•°é€‰æ‹© PTQ æˆ– QAT**ï¼›
    * **å®Œæˆé‡åŒ–åå¯é€‰å¯¼å‡º ONNX**ï¼›
    * **å¦‚æœå¯¼å‡ºåˆ™è‡ªåŠ¨ç”¨ ONNX Runtime è·‘ä¸€æ¬¡æ¨ç†éªŒè¯**ï¼›
    * ï¼ˆå¯é€‰æ‰©å±•ï¼‰çœŸå®å›¾ç‰‡æ¨ç†ã€åŸºå‡†æµ‹è¯•ã€mAP è¯„ä¼°ã€‚

    å…¶å®ä½ ç°åœ¨çš„ç¬¬äºŒä»½ä»£ç ï¼Œå·²ç»æ˜¯åˆå¹¶ç‰ˆäº†ï¼šå®ƒåŒ…å«äº†ç¬¬ä¸€ä¸ªè„šæœ¬çš„ PTQ/QAT åŠŸèƒ½ï¼Œåˆå¤šäº†å¯¼å‡ºå’Œæ¨ç†éªŒè¯ã€‚

    ğŸ‘‰ æ¢å¥è¯è¯´ï¼Œä½ å·²ç»æœ‰ä¸€ä¸ªâ€œæ•´åˆç‰ˆè„šæœ¬â€ã€‚å¦‚æœä½ æƒ³è¦æˆ‘å¸®ä½ å†ä¼˜åŒ–ä¸€ä¸‹ç»“æ„ï¼Œè®©å®ƒï¼š

    * æ”¯æŒ **çœŸå®æ•°æ®é›†åŠ è½½**ï¼›
    * æ”¯æŒ **onnxruntime æ¨ç†çœŸå®å›¾ç‰‡**ï¼›
    * è¾“å‡º **æ£€æµ‹æ¡†å¯è§†åŒ–**ï¼›
    * æ›´æ¸…æ™°åœ°åŒºåˆ† `train / quantize / export / benchmark` å››ä¸ªæ­¥éª¤ï¼›

    æˆ‘å¯ä»¥å¸®ä½ å†æ”¹é€ ä¸€ä¸‹ï¼Œè®©å®ƒæˆä¸ºä¸€ä¸ª**æ›´å®Œæ•´çš„ä¸€ç«™å¼ demo**ã€‚

    è¦ä¸è¦æˆ‘æŠŠä½ ç°åœ¨çš„è„šæœ¬æ”¹é€ æˆä¸€ä¸ª **å®Œæ•´çš„æ•´åˆç‰ˆ**ï¼ŒåŒ…å«ï¼š

    * `--mode ptq/qat`
    * `--export_onnx`
    * `--infer path/to/image.jpg` ï¼ˆonnxruntime æ¨ç†çœŸå®å›¾ç‰‡å¹¶æ˜¾ç¤ºæ£€æµ‹ç»“æœï¼‰


# nni_prune_yolov5s.py

    æˆ‘ç»™ä½ å†™çš„ demo ç”¨çš„æ˜¯ **`L1FilterPruner`**ï¼Œå®ƒå±äº **ç»“æ„åŒ–å‰ªæ**ã€‚

    åŒºåˆ«åœ¨äºï¼š

    * **éç»“æ„åŒ–å‰ªæï¼ˆUnstructured Pruningï¼‰**

    * ç›´æ¥æŠŠæƒé‡çŸ©é˜µä¸­çš„å•ä¸ªå…ƒç´ ç½®é›¶ï¼ˆæ¯”å¦‚é€‰å–æœ€å°çš„ 50% æƒé‡ç½®é›¶ï¼‰ã€‚
    * æ¨¡å‹å‚æ•°æ–‡ä»¶ï¼ˆ`.pth`ï¼‰å¤§å°ä¸ä¼šçœŸæ­£å˜å°ï¼Œå› ä¸ºé›¶å€¼ä»ç„¶å­˜å‚¨åœ¨é‡Œé¢ã€‚
    * ä½†è®¡ç®—é‡ç†è®ºä¸Šå¯ä»¥å‡å°‘ï¼Œå¦‚æœéƒ¨ç½²åˆ°æ”¯æŒç¨€ç–çŸ©é˜µåŠ é€Ÿçš„ç¡¬ä»¶ï¼ˆå¦‚éƒ¨åˆ† GPU / NPUï¼‰ã€‚

    * **ç»“æ„åŒ–å‰ªæï¼ˆStructured Pruningï¼‰**

    * ç›´æ¥è£å‰ªæ‰æ•´ä¸ªå·ç§¯æ ¸ã€æ•´ä¸ªé€šé“æˆ–æ•´ä¸ªå±‚ã€‚
    * å‰ªæå®Œæˆå¹¶ **å¯¼å‡ºæ¨¡å‹** åï¼Œç¡®å®ä¼šå‡å°‘å‚æ•°é‡å’Œæ¨¡å‹ä½“ç§¯ã€‚
    * åŒæ—¶æ¨ç†æ—¶è®¡ç®—é‡ï¼ˆFLOPsï¼‰ä¹Ÿä¼šå‡å°‘ï¼Œé€Ÿåº¦èƒ½çœŸæ­£æå‡ã€‚

    åœ¨ demo ä¸­ï¼š

    ```python
    config_list = [{
        'sparsity': 0.5,        # 50% filter å‰ªæ
        'op_types': ['Conv2d'], # åªå¯¹ Conv2d åšå‰ªæ
    }]
    pruner = L1FilterPruner(model, config_list, optimizer, trainer, evaluator)
    ```

    è¿™é‡Œçš„ `L1FilterPruner` é»˜è®¤æ˜¯ **æŒ‰ filter (å·ç§¯æ ¸) çš„ L1 èŒƒæ•°åšç»“æ„åŒ–å‰ªæ**ï¼Œæ‰€ä»¥å‰ªæåï¼š

    âœ… æ¨¡å‹å‚æ•°é‡å‡å°‘
    âœ… æ¨¡å‹ `.pth` æ–‡ä»¶å˜å°
    âœ… ç†è®ºè®¡ç®—é‡é™ä½ï¼ˆæ¨ç†é€Ÿåº¦æ›´å¿«ï¼‰

    âš ï¸ ä½†è¦æ³¨æ„ï¼š

    * NNI çš„ pruner åœ¨ `compress()` æ—¶ï¼Œæ¨¡å‹æƒé‡æ˜¯è¢«æ‰“ maskï¼Œè€ŒçœŸæ­£å¯¼å‡ºæ—¶ï¼ˆ`export_model`ï¼‰ï¼Œæ‰ä¼šæŠŠè¢«å‰ªæ‰çš„é€šé“ç§»é™¤ï¼Œå¾—åˆ°æ›´å°çš„æ¨¡å‹ã€‚
    * å‰ªæåä¸€èˆ¬éœ€è¦ **finetune** ä¸€æ®µæ—¶é—´ï¼Œä¸ç„¶ç²¾åº¦ä¼šä¸‹é™ã€‚

    ---

    è¦ä¸è¦æˆ‘å¸®ä½ å†™ä¸ªå°è„šæœ¬ï¼Œå¯¹æ¯” **åŸå§‹ YOLOv5s å’Œ å‰ªæåæ¨¡å‹çš„å‚æ•°é‡ (number of parameters) å’Œ å¤§å° (MB)**ï¼Œè¿™æ ·ä½ èƒ½ç›´è§‚çœ‹åˆ°å·®å¼‚ï¼Ÿ


    ä½ æå‡ºçš„é—®é¢˜éå¸¸å…³é”® âœ…ï¼Œè¿™æ˜¯ç»“æ„åŒ–å‰ªæä¸­æœ€å®¹æ˜“è¸©å‘çš„åœ°æ–¹ï¼Œå°¤å…¶æ˜¯ **YOLOv5s è¿™ç±»å¸¦ `shortcut`ï¼ˆæ®‹å·®ï¼‰ç»“æ„çš„ç½‘ç»œ**ã€‚æˆ‘ç»™ä½ è¯¦ç»†åˆ†æä¸€ä¸‹ï¼š

    ---

    ## 1ï¸âƒ£ YOLOv5s ä¸­çš„ shortcut

    * YOLOv5s çš„ backbone å’Œéƒ¨åˆ† neck å±‚ä¸­æœ‰ **æ®‹å·®ç»“æ„**ï¼š

    ```
    x = conv1(x)
    x = conv2(x)
    out = x + shortcut_input
    ```
    * è¿™é‡Œçš„ `x` å’Œ `shortcut_input` å¿…é¡» **é€šé“æ•°ç›¸åŒ**ï¼Œæ‰èƒ½æ‰§è¡Œ element-wise ç›¸åŠ ã€‚
    * å¦‚æœä½ ç›´æ¥å¯¹ `conv2d` å±‚åšç»“æ„åŒ–å‰ªæï¼ˆè£å‰ªé€šé“ï¼‰è€Œæ²¡æœ‰è€ƒè™‘ shortcut çš„è¾“å…¥é€šé“ï¼Œå¯èƒ½ä¼šå‡ºç°ï¼š

    ```
    RuntimeError: The size of tensor a (C1) must match the size of tensor b (C2) at non-singleton dimension 1
    ```

    å³ **é€šé“æ•°ä¸åŒ¹é…**ã€‚

    ---

    ## 2ï¸âƒ£ ä¸ºä»€ä¹ˆä¼šå‡ºé—®é¢˜

    * NNI çš„ `L1FilterPruner` é»˜è®¤å¯¹æ¯ä¸ª `Conv2d` ç‹¬ç«‹è£å‰ªï¼Œ**ä¸ä¼šè‡ªåŠ¨å¯¹ shortcut åˆ†æ”¯ä¿æŒä¸€è‡´**ã€‚
    * shortcut é€šå¸¸æ˜¯ identity æˆ–è€… 1x1 convï¼Œå¦‚æœä¸¤è¾¹é€šé“ä¸ä¸€è‡´ï¼Œç›´æ¥è£å‰ªå°±ä¼šå¯¼è‡´ **add æ“ä½œæ— æ³•åŒ¹é…**ã€‚

    ---

    ## 3ï¸âƒ£ è§£å†³æ–¹æ¡ˆ

    ### æ–¹æ³• Aï¼šåªè£å‰ªæ®‹å·®åˆ†æ”¯çš„æœ€åä¸€å±‚

    * åªå¯¹ `shortcut` ä¹‹å¤–çš„ conv å±‚å‰ªæï¼Œä¿è¯ shortcut ä¸¤ä¾§é€šé“ä¸€è‡´ã€‚
    * ç¼ºç‚¹ï¼šå‰ªæç©ºé—´æœ‰é™ï¼Œå‡å°å‚æ•°é‡å’Œ FLOPs ä¸å¤šã€‚

    ### æ–¹æ³• Bï¼šä½¿ç”¨ **group-aware / dependency-aware pruning**

    * NNI çš„é«˜çº§ pruner æˆ–è‡ªå®šä¹‰ `dependency` å¯ä»¥è®©å‰ªæå™¨**ä¿è¯æ®‹å·®åˆ†æ”¯é€šé“ä¸€è‡´**ï¼š

    * å¯¹äºæœ‰ shortcut çš„ blockï¼ŒæŠŠ `conv1`ã€`conv2`ã€shortcut çš„é€šé“ä¾èµ–åœ¨ä¸€èµ·å‰ªæã€‚
    * ä¹Ÿå°±æ˜¯ **åŒä¸€ block å†…ï¼Œé€šé“è£å‰ªæ¯”ä¾‹ä¸€è‡´**ã€‚
    * ä¼˜ç‚¹ï¼šä¿è¯ç½‘ç»œç»“æ„æ­£ç¡®ï¼Œé¿å…è¿è¡Œæ—¶é”™è¯¯ã€‚

    ### æ–¹æ³• Cï¼šå‰ªæå‰ä¿®æ”¹æ¨¡å‹

    * åœ¨å‰ªæä¹‹å‰ï¼ŒæŠŠ `shortcut` æ”¹ä¸º 1x1 convï¼Œæˆ–è€…åŠ ä¸Šé€šé“å¯¹é½æ¨¡å—ï¼ˆ`nn.Conv2d` è°ƒæ•´é€šé“ï¼‰ã€‚
    * å‰ªæåä»èƒ½ä¿æŒé€šé“åŒ¹é…ã€‚
    * è¿™ç§æ–¹æ³•æ¯”è¾ƒ invasiveï¼Œéœ€è¦å¯¹ YOLOv5 æºç æ”¹åŠ¨ã€‚

    ---

    ## 4ï¸âƒ£ å®é™…å»ºè®®

    1. **ä¸è¦å¯¹ shortcut ä¸¤ç«¯çš„ Conv2d ç‹¬ç«‹è£å‰ª**ã€‚
    2. ä½¿ç”¨ **NNI çš„ `dependency_aware=True` åŠŸèƒ½**ï¼ˆæˆ–è‡ªå®šä¹‰ prunerï¼‰ï¼Œç¡®ä¿ residual block å†…çš„ conv å±‚é€šé“ä¸€è‡´ã€‚
    3. å‰ªæå®Œæˆå **ä¸€å®šè¦é‡æ–°å¾®è°ƒ**ï¼Œæ¢å¤ç²¾åº¦ã€‚

    ---

    æˆ‘å¯ä»¥å¸®ä½ å†™ä¸€ä¸ª **YOLOv5s ä¸“ç”¨çš„å‰ªæ demo**ï¼Œå¸¦ä¸Š **shortcut-aware çš„ç»“æ„åŒ–å‰ªæ**ï¼Œä¿è¯æ®‹å·®é€šé“åŒ¹é…ï¼Œå¹¶å¯¼å‡ºå¯è®­ç»ƒæ¨¡å‹ã€‚

    ä½ æƒ³è®©æˆ‘ç›´æ¥å†™è¿™ä¸ªç‰ˆæœ¬å—ï¼Ÿ



    å¥½çš„ï¼Œæˆ‘è¯¦ç»†ç»™ä½ è§£é‡Šä¸€ä¸‹ NNI çš„ `dependency_aware=True` çš„ä½œç”¨ï¼Œä»¥åŠå®ƒåœ¨å‰ªæ YOLOv5 è¿™ç§å¸¦ shortcut çš„ç½‘ç»œé‡Œçš„æ„ä¹‰ã€‚

    ---

    ## 1ï¸âƒ£ `dependency_aware` çš„æ¦‚å¿µ

    åœ¨ **NNI çš„ç»“æ„åŒ–å‰ªæï¼ˆPrunerï¼‰** ä¸­ï¼Œé»˜è®¤å‰ªæå™¨ä¼š **ç‹¬ç«‹å¯¹æ¯ä¸ªå·ç§¯å±‚è£å‰ªé€šé“**ï¼Œå¿½ç•¥å±‚ä¸å±‚ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚

    * ä¾èµ–å…³ç³»ï¼ˆDependencyï¼‰å¸¸è§åœºæ™¯ï¼š

    1. **æ®‹å·®è¿æ¥ï¼ˆshortcut / skip connectionï¼‰**

        * ä¸¤æ¡åˆ†æ”¯åš element-wise addï¼Œé€šé“æ•°å¿…é¡»ä¸€è‡´ã€‚
    2. **Concat å±‚ï¼ˆç‰¹å¾å›¾æ‹¼æ¥ï¼‰**

        * å¤šæ¡åˆ†æ”¯ concatï¼Œé€šé“æ•°å½±å“è¾“å‡ºé€šé“æ•°ã€‚
    3. **1x1 conv è°ƒæ•´é€šé“**

        * å¯èƒ½ä½œä¸º shortcut çš„æŠ•å½±ï¼Œé€šé“æ•°å—ä¸Šæ¸¸ä¾èµ–é™åˆ¶ã€‚

    å¦‚æœä¸è€ƒè™‘ä¾èµ–å…³ç³»å‰ªæï¼Œè£å‰ªåå¯èƒ½å‡ºç° **é€šé“ä¸åŒ¹é…**ï¼Œå¯¼è‡´è¿è¡Œæ—¶æŠ¥é”™ã€‚

    ---

    ## 2ï¸âƒ£ `dependency_aware=True` çš„ä½œç”¨

    å½“ä½ è®¾ç½®ï¼š

    ```python
    pruner = L1FilterPruner(model, config_list, optimizer, trainer, evaluator, dependency_aware=True)
    ```

    * **NNI ä¼šåœ¨å†…éƒ¨æ„å»ºä¾èµ–å›¾**ï¼š

    * æ‰¾åˆ°å“ªäº›å±‚åœ¨ç½‘ç»œä¸­æœ‰é€šé“ä¾èµ–å…³ç³»ï¼ˆshortcutã€concatã€add ç­‰ï¼‰ï¼›
    * åœ¨å‰ªææ—¶ï¼Œä¼š **ç»Ÿä¸€å¤„ç†ä¾èµ–å±‚**ï¼š

        * å¯¹ residual blockï¼Œä¿è¯ add ä¸¤ä¾§çš„é€šé“åŒæ—¶å‰ªæ‰å¯¹åº”çš„ filterï¼›
        * å¯¹ concat åˆ†æ”¯ï¼Œä¿è¯è¾“å‡ºé€šé“ä¸ downstream layer ä¸€è‡´ï¼›
    * ç»“æœï¼šå‰ªæå **ç½‘ç»œç»“æ„ä¸ä¼šç ´å**ï¼Œå¯ä»¥ç›´æ¥ forwardã€‚

    ç®€è€Œè¨€ä¹‹ï¼š

    > `dependency_aware=True` å¯ä»¥è®©å‰ªæå™¨\*\*â€œæ™ºèƒ½åœ°â€ä¿æŒå±‚é—´ä¾èµ–ä¸€è‡´æ€§\*\*ï¼Œé¿å…æ®‹å·®/concat é€šé“ä¸åŒ¹é…çš„é—®é¢˜ã€‚

    ---

    ## 3ï¸âƒ£ ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

    ### YOLOv5s æ®‹å·® block

    ```text
    x = conv1(x)
    x = conv2(x)
    out = x + shortcut
    ```

    * å¦‚æœç‹¬ç«‹å‰ªæ conv2ï¼Œå¯èƒ½å¯¼è‡´ `x.shape[1] != shortcut.shape[1]` â†’ runtime errorã€‚
    * å¼€å¯ `dependency_aware=True`ï¼ŒNNI ä¼šï¼š

    * åœ¨åŒä¸€ä¸ª residual block å†…æŠŠ conv1/conv2/shortcut é€šé“**ç»Ÿä¸€è£å‰ª**ï¼›
    * ä¿è¯ add æ“ä½œå®‰å…¨ï¼›
    * å‰ªæåçš„é€šé“æ•°å’Œ mask æ˜¯ä¸€è‡´çš„ã€‚

    ---

    ## 4ï¸âƒ£ å°ç»“

    | å±æ€§                       | ä½œç”¨                                      |
    | ------------------------ | --------------------------------------- |
    | `dependency_aware=False` | é€å±‚ç‹¬ç«‹å‰ªæï¼Œå¯èƒ½ç ´åç½‘ç»œç»“æ„ï¼ˆshortcut/concat ç­‰ï¼‰      |
    | `dependency_aware=True`  | è‡ªåŠ¨è€ƒè™‘ä¾èµ–å…³ç³»ï¼Œä¿æŒ residual/concat ç­‰é€šé“ä¸€è‡´æ€§ï¼Œå®‰å…¨å‰ªæ |

    ---

    å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ æ”¹å†™ä¹‹å‰çš„ YOLOv5s **ç»“æ„åŒ–å‰ªæ demo**ï¼ŒåŠ å…¥ï¼š

    * `dependency_aware=True`
    * è‡ªåŠ¨è¯†åˆ« residual block å¹¶å‰ªæ
    * å‰ªæåå¯¼å‡ºå¯è®­ç»ƒæ¨¡å‹

    è¿™æ ·å°±èƒ½ç›´æ¥å®‰å…¨åœ¨ YOLOv5s ä¸Šè·‘äº†ã€‚

    ä½ å¸Œæœ›æˆ‘ç›´æ¥å†™è¿™ä¸ªç‰ˆæœ¬å—ï¼Ÿ


# nni_distillation_yolov5s.py

    å¥½çš„ï¼Œæˆ‘æ¥è¯¦ç»†è¯´æ˜å¦‚ä½•ç”¨ **NNI å¯¹ YOLOv5s åšçŸ¥è¯†è’¸é¦ï¼ˆKnowledge Distillationï¼‰**ï¼Œå¹¶ç»™ä½ ä¸€ä¸ªåŸºç¡€çš„ Demo ç¤ºä¾‹ã€‚

    ---

    ## 1ï¸âƒ£ åŸºæœ¬åŸç†

    **çŸ¥è¯†è’¸é¦ (Knowledge Distillation, KD)** çš„ç›®æ ‡ï¼š

    * ç”¨ä¸€ä¸ª **å¤§æ¨¡å‹ï¼ˆTeacherï¼‰** æŒ‡å¯¼ **å°æ¨¡å‹ï¼ˆStudentï¼‰** å­¦ä¹ è¾“å‡ºåˆ†å¸ƒ
    * å¸¸ç”¨æ–¹æ³•ï¼š

    1. **Logitsè’¸é¦**ï¼šæœ€å¸¸è§ï¼ŒStudent å­¦ä¹  Teacher çš„ softmax è¾“å‡º
    2. **Feature Mapè’¸é¦**ï¼šStudent å­¦ä¹  Teacher ä¸­é—´ç‰¹å¾å›¾
    3. **Attention è’¸é¦**ï¼šStudent å­¦ä¹  Teacher çš„æ³¨æ„åŠ›åˆ†å¸ƒ

    **åœ¨ YOLOv5 ä¸Š**ï¼Œå¯ä»¥ï¼š

    * Teacher: é¢„è®­ç»ƒå®Œæ•´ YOLOv5s æˆ–æ›´å¤§æ¨¡å‹
    * Student: å¯ä»¥æ˜¯è£å‰ªåçš„ YOLOv5sï¼ˆå‰ªæ/è½»é‡åŒ–ï¼‰
    * è’¸é¦ loss = Î± \* åŸå§‹ä»»åŠ¡ loss + Î² \* è’¸é¦ loss

    ---

    ## 2ï¸âƒ£ ä½¿ç”¨ NNI è’¸é¦

    NNI æä¾›äº† **`Distillation` API**ï¼š

    ```python
    from nni.algorithms.compression.pytorch.distillation import Distillation

    distiller = Distillation(
        student_model=student,
        teacher_model=teacher,
        config_list=[{
            'distill_type': 'logits',   # æˆ– 'feature'
            'temperature': 4.0,
            'alpha': 0.7,               # è’¸é¦ loss æƒé‡
            'beta': 0.3                 # åŸå§‹ loss æƒé‡
        }]
    )
    student_model = distiller.compress()
    ```

    * `compress()` ä¼šè¿”å›å¯ä»¥ç›´æ¥è®­ç»ƒçš„ Student æ¨¡å‹
    * NNI å†…éƒ¨ä¼šåœ¨ forward æ—¶è®¡ç®—è’¸é¦ lossï¼Œå¹¶ç»“åˆåŸå§‹ä»»åŠ¡ loss

    ---

    ## 3ï¸âƒ£ YOLOv5s è’¸é¦ Demo

    ä¸‹é¢ç»™ä½ ä¸€ä¸ª **æœ€ç®€åŒ–ç¤ºä¾‹**ï¼Œç”¨ NNI åš logits è’¸é¦ï¼š

    ```python
    import torch
    import torch.nn as nn
    from ultralytics import YOLO
    from torch.utils.data import Dataset, DataLoader
    import numpy as np

    from nni.algorithms.compression.pytorch.distillation import Distillation

    # -----------------------------
    # Dummy dataset
    # -----------------------------
    class RandomDataset(Dataset):
        def __init__(self, n=100, img_size=640):
            self.n = n
            self.img_size = img_size

        def __len__(self):
            return self.n

        def __getitem__(self, idx):
            x = np.random.rand(3, self.img_size, self.img_size).astype(np.float32)
            y = np.zeros((1, 6), dtype=np.float32)  # [cls, x, y, w, h, conf]
            return torch.from_numpy(x), torch.from_numpy(y)

    def get_dataloader(n=20):
        return DataLoader(RandomDataset(n=n), batch_size=2, shuffle=True)

    # -----------------------------
    # è’¸é¦ç¤ºä¾‹
    # -----------------------------
    def distillation_demo():
        # Teacher model (å¤§æ¨¡å‹)
        teacher = YOLO("yolov5s.pt").model
        teacher.eval()

        # Student model (å°æ¨¡å‹ï¼Œå¯ä»¥æ˜¯å‰ªææˆ–è½»é‡åŒ–æ¨¡å‹)
        student = YOLO("yolov5s.pt").model

        # è’¸é¦é…ç½®
        config_list = [{
            'distill_type': 'logits',   # ä½¿ç”¨ logits è’¸é¦
            'temperature': 4.0,
            'alpha': 0.7,               # KD loss æƒé‡
            'beta': 0.3                 # åŸå§‹ä»»åŠ¡ loss æƒé‡
        }]

        # æ„å»º distiller
        distiller = Distillation(student_model=student, teacher_model=teacher, config_list=config_list)

        # è¿”å›å¯è®­ç»ƒçš„ student æ¨¡å‹
        student_model = distiller.compress()
        return student_model

    # -----------------------------
    # Training loop
    # -----------------------------
    def train_student(student_model, dataloader, epochs=1):
        optimizer = torch.optim.SGD(student_model.parameters(), lr=1e-3, momentum=0.9)
        criterion = nn.MSELoss()  # è¿™é‡Œåªæ˜¯ç¤ºä¾‹ï¼ŒçœŸå®ç”¨ YOLO loss

        student_model.train()
        for epoch in range(epochs):
            for imgs, labels in dataloader:
                preds = student_model(imgs)
                if isinstance(preds, (list, tuple)):
                    preds = preds[0]
                loss = criterion(preds, torch.zeros_like(preds))  # dummy loss
                optimizer.zero_grad()
                loss.backward()
                optimizer.step()
            print(f"[KD] Epoch {epoch+1}/{epochs}, loss={loss.item():.4f}")

    # -----------------------------
    # Main
    # -----------------------------
    def main():
        dataloader = get_dataloader(n=20)
        student_model = distillation_demo()
        train_student(student_model, dataloader, epochs=2)
        torch.save(student_model.state_dict(), "yolov5s_student_kd.pth")
        print("[Done] Knowledge Distillation finished.")

    if __name__ == "__main__":
        main()
    ```

    ---

    ## 4ï¸âƒ£ æ³¨æ„äº‹é¡¹

    1. **è’¸é¦æŸå¤±**

    * ä¸Šé¢ç¤ºä¾‹ç”¨ MSELoss åªæ˜¯æ¼”ç¤º
    * YOLOv5 çœŸå®è®­ç»ƒæ—¶ï¼Œéœ€ç”¨å®Œæ•´çš„ **bbox loss + obj loss + class loss**

    2. **å­¦ç”Ÿæ¨¡å‹å¯ä»¥æ˜¯å‰ªæåçš„æ¨¡å‹**

    * å¯ä»¥ç»“åˆä¹‹å‰çš„ `L1FilterPruner` æˆ– `SlimPruner`
    * è’¸é¦å¯å¸®åŠ©æ¢å¤å‰ªæåç²¾åº¦ä¸‹é™

    3. **æ¸©åº¦ç³»æ•° `temperature`**

    * è¶Šå¤§ softmax è¶Šå¹³æ»‘
    * å»ºè®® 2\~4 èŒƒå›´

    4. **è®­ç»ƒé¡ºåº**

    * ä¸€èˆ¬å…ˆåšå‰ªæ / è½»é‡åŒ–
    * å†ç”¨ KD è’¸é¦å¾®è°ƒ student æ¨¡å‹

    ---

    å¦‚æœä½ å¸Œæœ›ï¼Œæˆ‘å¯ä»¥å¸®ä½ å†™ä¸€ä¸ª **å‰ªæ + çŸ¥è¯†è’¸é¦ + é‡åŒ–çš„ä¸€ä½“åŒ– pipeline demo**ï¼Œå®ç°ï¼š

    1. YOLOv5s å‰ªæï¼ˆç»“æ„åŒ–ï¼Œdependency-awareï¼‰
    2. å‰ªæåçš„ student ç”¨ teacher åšçŸ¥è¯†è’¸é¦
    3. è’¸é¦åå†åš PTQ æˆ– QAT é‡åŒ–
    4. æœ€ç»ˆå¯¼å‡º ONNXï¼Œå¯ç›´æ¥æ¨ç†

    è¿™æ ·å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„å‹ç¼©éƒ¨ç½²æµç¨‹ã€‚

    ä½ å¸Œæœ›æˆ‘å¸®ä½ åšè¿™ä¸ªæ•´åˆç‰ˆå—ï¼Ÿ
